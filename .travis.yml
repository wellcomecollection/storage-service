# Travis uses the environment variable to determine the cache: if two jobs
# have different environment variables, they get different caches.
# See https://docs.travis-ci.com/user/caching/#caches-and-build-matrices
#
# We want to share the Scala/sbt cache between multiple jobs, so we don't
# have any environment variables attached to the tasks.

jobs:
  include:
    - stage: preflight
      script: TASK=travis-format              ./.travis/run_job.py

    - stage: libraries
      script: SBT_PROJECT=common              ./.travis/run_job.py
    - script: SBT_PROJECT=display             ./.travis/run_job.py
    - script: SBT_PROJECT=ingests_common      ./.travis/run_job.py

    - stage: services
      script: SBT_PROJECT=bags_api            ./.travis/run_job.py
    - script: SBT_PROJECT=bag_register        ./.travis/run_job.py
    - script: SBT_PROJECT=bag_replicator      ./.travis/run_job.py
    - script: SBT_PROJECT=bag_root_finder     ./.travis/run_job.py
    - script: SBT_PROJECT=bag_unpacker        ./.travis/run_job.py
    - script: SBT_PROJECT=bag_verifier        ./.travis/run_job.py
    - script: SBT_PROJECT=bag_versioner       ./.travis/run_job.py
    - script: SBT_PROJECT=ingests             ./.travis/run_job.py
    - script: SBT_PROJECT=ingests_api         ./.travis/run_job.py
    - script: SBT_PROJECT=replica_aggregator  ./.travis/run_job.py

    - script: SBT_PROJECT=notifier            ./.travis/run_job.py

cache:
  directories:
    - $HOME/.sbt
    - $HOME/.ivy2/cache
    - project/target
    - target

    - api/bags_api/target
    - api/ingests_api/target
    - bag_replicator/target
    - bag_register/target
    - bag_root_finder/target
    - bag_unpacker/target
    - bag_verifier/target
    - bag_versioner/target
    - common/target
    - display/target
    - ingests/target
    - ingests_common/target
    - notifier/target
    - replica_aggregator/target

stages:
  - preflight
  - libraries
  - services

before_install:
  - openssl aes-256-cbc -K $encrypted_83630750896a_key -iv $encrypted_83630750896a_iv -in secrets.zip.enc -out secrets.zip -d
  - unzip secrets.zip
  - chmod 600 id_rsa
  - mkdir -p ~/.aws
  - cp config ~/.aws/config
  - cp credentials ~/.aws/credentials

language: sh

services:
  - docker

dist: trusty

branches:
  only:
    - master

before_cache:
  # Based on instructions from
  # https://www.scala-sbt.org/1.0/docs/Travis-CI-with-sbt.html#Caching
  - sudo find $HOME/.ivy2/cache -name "ivydata-*.properties" -print -delete
  - sudo find $HOME/.sbt        -name "*.lock"               -print -delete

env:
  global:
    # This forces Python to print everything to stdout/stderr immediately.
    # Otherwise, we've seen issues where all the output from our Travis scripts
    # gets buffered, and only gets printed at the end of the test...
    #
    # ... out of order from the rest of the rest of the output!
    #
    # See also: https://docs.python.org/3/using/cmdline.html#cmdoption-u
    #
    - PYTHONUNBUFFERED=x
